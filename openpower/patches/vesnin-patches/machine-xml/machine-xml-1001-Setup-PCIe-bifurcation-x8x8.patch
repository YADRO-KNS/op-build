From 956bf4cc699366f859b892911bbc418206bd1968 Mon Sep 17 00:00:00 2001
From: Artem Senichev <a.senichev@yadro.com>
Date: Fri, 21 Jun 2019 15:08:09 +0300
Subject: [PATCH] Setup PCIe bifurcation (x8x8)

PCIe ports connected to CPU1 and CPU3 now work as x8x8 instead of x16.

Signed-off-by: Artem Senichev <a.senichev@yadro.com>
---
 vesnin.xml | 240 +++++++++++++++++++++++++++++++++++++++++++++++------
 1 file changed, 216 insertions(+), 24 deletions(-)

diff --git a/vesnin.xml b/vesnin.xml
index 7f990b5..b4281f3 100644
--- a/vesnin.xml
+++ b/vesnin.xml
@@ -10445,14 +10445,28 @@
 		</property>
 	</globalSetting>
 	<globalSetting>
-		<id>/sys-0/node-0/ponderosa-0/c1p1x16-4</id>
+		<id>/sys-0/node-0/ponderosa-0/c1p1x8a-4</id>
 		<property>
 			<id>IO_CONFIG_SELECT</id>
 			<value></value>
 		</property>
 	</globalSetting>
 	<globalSetting>
-		<id>/sys-0/node-0/ponderosa-0/c1p1x16-4/StorageConnector1-3</id>
+		<id>/sys-0/node-0/ponderosa-0/c1p1x8a-4/StorageConnector1-3</id>
+		<property>
+			<id>IO_CONFIG_SELECT</id>
+			<value></value>
+		</property>
+	</globalSetting>
+	<globalSetting>
+		<id>/sys-0/node-0/ponderosa-0/c1p1x8b-5</id>
+		<property>
+			<id>IO_CONFIG_SELECT</id>
+			<value></value>
+		</property>
+	</globalSetting>
+	<globalSetting>
+		<id>/sys-0/node-0/ponderosa-0/c1p1x8b-5/StorageConnector2-4</id>
 		<property>
 			<id>IO_CONFIG_SELECT</id>
 			<value></value>
@@ -10515,14 +10529,28 @@
 		</property>
 	</globalSetting>
 	<globalSetting>
-		<id>/sys-0/node-0/ponderosa-0/c3p1x16-10</id>
+		<id>/sys-0/node-0/ponderosa-0/c3p1x8a-10</id>
+		<property>
+			<id>IO_CONFIG_SELECT</id>
+			<value></value>
+		</property>
+	</globalSetting>
+	<globalSetting>
+		<id>/sys-0/node-0/ponderosa-0/c3p1x8a-10/StorageConnector4-9</id>
+		<property>
+			<id>IO_CONFIG_SELECT</id>
+			<value></value>
+		</property>
+	</globalSetting>
+	<globalSetting>
+		<id>/sys-0/node-0/ponderosa-0/c3p1x8b-11</id>
 		<property>
 			<id>IO_CONFIG_SELECT</id>
 			<value></value>
 		</property>
 	</globalSetting>
 	<globalSetting>
-		<id>/sys-0/node-0/ponderosa-0/c3p1x16-10/StorageConnector4-9</id>
+		<id>/sys-0/node-0/ponderosa-0/c3p1x8b-11/StorageConnector5-10</id>
 		<property>
 			<id>IO_CONFIG_SELECT</id>
 			<value></value>
@@ -13752,12 +13780,14 @@
 		<child_id>c0p0x8a-0</child_id>
 		<child_id>c0p0x8b-2</child_id>
 		<child_id>c1p0x16-3</child_id>
-		<child_id>c1p1x16-4</child_id>
+		<child_id>c1p1x8a-4</child_id>
+		<child_id>c1p1x8b-5</child_id>
 		<child_id>c2p0x16-6</child_id>
 		<child_id>c2p1x8a-7</child_id>
 		<child_id>c2p1x8b-8</child_id>
 		<child_id>c3p0x16-9</child_id>
-		<child_id>c3p1x16-10</child_id>
+		<child_id>c3p1x8a-10</child_id>
+		<child_id>c3p1x8b-11</child_id>
 		<child_id>birchconn-0</child_id>
 		<child_id>birchconn-1</child_id>
 		<child_id>birchconn-2</child_id>
@@ -15023,10 +15053,10 @@
 			</bus_attribute>
 		</bus>
 		<bus>
-			<bus_id>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x16/E0_x16 => c1p0x16-3/PcieSlot1x16-2/pciep</bus_id>
+			<bus_id>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x8x8/E0_x16 => c1p0x16-3/PcieSlot1x16-2/pciep</bus_id>
 			<bus_type>PCIE</bus_type>
 			<cable>no</cable>
-			<source_path>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x16/</source_path>
+			<source_path>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x8x8/</source_path>
 			<source_target>E0_x16</source_target>
 			<dest_path>c1p0x16-3/PcieSlot1x16-2/</dest_path>
 			<dest_target>pciep</dest_target>
@@ -15048,12 +15078,12 @@
 			</bus_attribute>
 		</bus>
 		<bus>
-			<bus_id>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x16/E1_x16 => c1p1x16-4/StorageConnector1-3/pciep</bus_id>
+			<bus_id>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x8x8/E1_CLK0_x8 => c1p1x8a-4/StorageConnector1-3/pciep</bus_id>
 			<bus_type>PCIE</bus_type>
 			<cable>no</cable>
-			<source_path>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x16/</source_path>
-			<source_target>E1_x16</source_target>
-			<dest_path>c1p1x16-4/StorageConnector1-3/</dest_path>
+			<source_path>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x8x8/</source_path>
+			<source_target>E1_CLK0_x8</source_target>
+			<dest_path>c1p1x8a-4/StorageConnector1-3/</dest_path>
 			<dest_target>pciep</dest_target>
 			<bus_attribute>
 				<id>CLASS</id>
@@ -15061,7 +15091,32 @@
 			</bus_attribute>
 			<bus_attribute>
 				<id>LANE_REVERSAL</id>
-				<default>00</default>
+				<default>1</default>
+			</bus_attribute>
+			<bus_attribute>
+				<id>PCIE_LANE_EQUALIZATION</id>
+				<default>all,0x33,0x33</default>
+			</bus_attribute>
+			<bus_attribute>
+				<id>PCIE_SWAP_CLKS</id>
+				<default>0</default>
+			</bus_attribute>
+		</bus>
+		<bus>
+			<bus_id>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x8x8/E1_CLK1_x8 => c1p1x8b-5/StorageConnector2-4/pciep</bus_id>
+			<bus_type>PCIE</bus_type>
+			<cable>no</cable>
+			<source_path>proc_socket-1/module-1/proc/pci_configs/E0_x16:E1_x8x8/</source_path>
+			<source_target>E1_CLK1_x8</source_target>
+			<dest_path>c1p1x8b-5/StorageConnector2-4/</dest_path>
+			<dest_target>pciep</dest_target>
+			<bus_attribute>
+				<id>CLASS</id>
+				<default>BUS</default>
+			</bus_attribute>
+			<bus_attribute>
+				<id>LANE_REVERSAL</id>
+				<default>1</default>
 			</bus_attribute>
 			<bus_attribute>
 				<id>PCIE_LANE_EQUALIZATION</id>
@@ -15148,10 +15203,10 @@
 			</bus_attribute>
 		</bus>
 		<bus>
-			<bus_id>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x16/E0_x16 => c3p0x16-9/PcieSlot4x16-8/pciep</bus_id>
+			<bus_id>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x8x8/E0_x16 => c3p0x16-9/PcieSlot4x16-8/pciep</bus_id>
 			<bus_type>PCIE</bus_type>
 			<cable>no</cable>
-			<source_path>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x16/</source_path>
+			<source_path>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x8x8/</source_path>
 			<source_target>E0_x16</source_target>
 			<dest_path>c3p0x16-9/PcieSlot4x16-8/</dest_path>
 			<dest_target>pciep</dest_target>
@@ -15173,12 +15228,37 @@
 			</bus_attribute>
 		</bus>
 		<bus>
-			<bus_id>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x16/E1_x16 => c3p1x16-10/StorageConnector4-9/pciep</bus_id>
+			<bus_id>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x8x8/E1_CLK0_x8 => c3p1x8a-10/StorageConnector4-9/pciep</bus_id>
+			<bus_type>PCIE</bus_type>
+			<cable>no</cable>
+			<source_path>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x8x8/</source_path>
+			<source_target>E1_CLK0_x8</source_target>
+			<dest_path>c3p1x8a-10/StorageConnector4-9/</dest_path>
+			<dest_target>pciep</dest_target>
+			<bus_attribute>
+				<id>CLASS</id>
+				<default>BUS</default>
+			</bus_attribute>
+			<bus_attribute>
+				<id>LANE_REVERSAL</id>
+				<default>1</default>
+			</bus_attribute>
+			<bus_attribute>
+				<id>PCIE_LANE_EQUALIZATION</id>
+				<default>all,0x33,0x33</default>
+			</bus_attribute>
+			<bus_attribute>
+				<id>PCIE_SWAP_CLKS</id>
+				<default>0</default>
+			</bus_attribute>
+		</bus>
+		<bus>
+			<bus_id>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x8x8/E1_CLK1_x8 => c3p1x8b-11/StorageConnector5-10/pciep</bus_id>
 			<bus_type>PCIE</bus_type>
 			<cable>no</cable>
-			<source_path>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x16/</source_path>
-			<source_target>E1_x16</source_target>
-			<dest_path>c3p1x16-10/StorageConnector4-9/</dest_path>
+			<source_path>proc_socket-3/module-1/proc/pci_configs/E0_x16:E1_x8x8/</source_path>
+			<source_target>E1_CLK1_x8</source_target>
+			<dest_path>c3p1x8b-11/StorageConnector5-10/</dest_path>
 			<dest_target>pciep</dest_target>
 			<bus_attribute>
 				<id>CLASS</id>
@@ -15186,7 +15266,7 @@
 			</bus_attribute>
 			<bus_attribute>
 				<id>LANE_REVERSAL</id>
-				<default>11</default>
+				<default>1</default>
 			</bus_attribute>
 			<bus_attribute>
 				<id>PCIE_LANE_EQUALIZATION</id>
@@ -19587,10 +19667,10 @@
 		</attribute>
 	</targetInstance>
 	<targetInstance>
-		<id>c1p1x16-4</id>
+		<id>c1p1x8a-4</id>
 		<type>slot-pcieslot-generic</type>
 		<library_target>false</library_target>
-		<instance_name>c1p1x16</instance_name>
+		<instance_name>c1p1x8a</instance_name>
 		<position>4</position>
 		<child_id>StorageConnector1-3</child_id>
 		<attribute>
@@ -19642,6 +19722,62 @@
 			<default></default>
 		</attribute>
 	</targetInstance>
+	<targetInstance>
+		<id>c1p1x8b-5</id>
+		<type>slot-pcieslot-generic</type>
+		<library_target>false</library_target>
+		<instance_name>c1p1x8b</instance_name>
+		<position>5</position>
+		<child_id>StorageConnector2-4</child_id>
+		<attribute>
+			<id>CLASS</id>
+			<default>CONNECTOR</default>
+		</attribute>
+		<attribute>
+			<id>MODEL</id>
+			<default></default>
+		</attribute>
+		<attribute>
+			<id>MRW_TYPE</id>
+			<default>NA</default>
+		</attribute>
+		<attribute>
+			<id>RESOURCE_IS_CRITICAL</id>
+			<default>0</default>
+		</attribute>
+		<attribute>
+			<id>TYPE</id>
+			<default>NA</default>
+		</attribute>
+	</targetInstance>
+	<targetInstance>
+		<id>StorageConnector2-4</id>
+		<type>card-pciecard-cablecard</type>
+		<library_target>true</library_target>
+		<instance_name>StorageConnector2</instance_name>
+		<position>4</position>
+		<child_id>pciep</child_id>
+		<attribute>
+			<id>CLASS</id>
+			<default>CARD</default>
+		</attribute>
+		<attribute>
+			<id>MODEL</id>
+			<default></default>
+		</attribute>
+		<attribute>
+			<id>MRW_TYPE</id>
+			<default>NA</default>
+		</attribute>
+		<attribute>
+			<id>RESOURCE_IS_CRITICAL</id>
+			<default>0</default>
+		</attribute>
+		<attribute>
+			<id>TYPE</id>
+			<default></default>
+		</attribute>
+	</targetInstance>
 	<targetInstance>
 		<id>c2p0x16-6</id>
 		<type>slot-pcieslot-generic</type>
@@ -19867,10 +20003,10 @@
 		</attribute>
 	</targetInstance>
 	<targetInstance>
-		<id>c3p1x16-10</id>
+		<id>c3p1x8a-10</id>
 		<type>slot-pcieslot-generic</type>
 		<library_target>false</library_target>
-		<instance_name>c3p1x16</instance_name>
+		<instance_name>c3p1x8a</instance_name>
 		<position>10</position>
 		<child_id>StorageConnector4-9</child_id>
 		<attribute>
@@ -19922,6 +20058,62 @@
 			<default></default>
 		</attribute>
 	</targetInstance>
+	<targetInstance>
+		<id>c3p1x8b-11</id>
+		<type>slot-pcieslot-generic</type>
+		<library_target>false</library_target>
+		<instance_name>c3p1x8b</instance_name>
+		<position>11</position>
+		<child_id>StorageConnector5-10</child_id>
+		<attribute>
+			<id>CLASS</id>
+			<default>CONNECTOR</default>
+		</attribute>
+		<attribute>
+			<id>MODEL</id>
+			<default></default>
+		</attribute>
+		<attribute>
+			<id>MRW_TYPE</id>
+			<default>NA</default>
+		</attribute>
+		<attribute>
+			<id>RESOURCE_IS_CRITICAL</id>
+			<default>0</default>
+		</attribute>
+		<attribute>
+			<id>TYPE</id>
+			<default>NA</default>
+		</attribute>
+	</targetInstance>
+	<targetInstance>
+		<id>StorageConnector5-10</id>
+		<type>card-pciecard-cablecard</type>
+		<library_target>true</library_target>
+		<instance_name>StorageConnector5</instance_name>
+		<position>10</position>
+		<child_id>pciep</child_id>
+		<attribute>
+			<id>CLASS</id>
+			<default>CARD</default>
+		</attribute>
+		<attribute>
+			<id>MODEL</id>
+			<default></default>
+		</attribute>
+		<attribute>
+			<id>MRW_TYPE</id>
+			<default>NA</default>
+		</attribute>
+		<attribute>
+			<id>RESOURCE_IS_CRITICAL</id>
+			<default>0</default>
+		</attribute>
+		<attribute>
+			<id>TYPE</id>
+			<default></default>
+		</attribute>
+	</targetInstance>
 	<targetInstance>
 		<id>birchconn-0</id>
 		<type>connector-card-generic</type>
-- 
2.22.0

